/* project 1 template->timer interrupt */#include<p32xxxx.h>#include<plib.h>#pragma config FPLLMUL = MUL_20, FPLLIDIV = DIV_2, FPLLODIV = DIV_1, FWDTEN = OFF#pragma config POSCMOD = HS, FNOSC = PRIPLL, FPBDIV = DIV_2#define SLed1 LATBbits.LATB10#define SLed2 LATBbits.LATB11#define SLed3 LATBbits.LATB12#define SLed4 LATBbits.LATB13#define SegA1 LATEbits.LATE0#define SegB1 LATEbits.LATE1#define SegC1 LATEbits.LATE2#define SegD1 LATEbits.LATE3#define SegE1 LATGbits.LATG9#define SegF1 LATGbits.LATG8#define SegG1 LATGbits.LATG7// Display selection. 0 = right, 1 = left (Cathode)#define DispSel1 LATGbits.LATG6//JC and JD#define SegA LATGbits.LATG12#define SegB LATGbits.LATG13#define SegC LATGbits.LATG14#define SegD LATGbits.LATG15#define SegE LATDbits.LATD7#define SegF LATDbits.LATD1#define SegG LATDbits.LATD9// Display selection. 0 = right, 1 = left (Cathode)#define DispSel LATCbits.LATC1//key pad#define C4 PORTBbits.RB0#define C3 PORTBbits.RB1#define C2 PORTBbits.RB2#define C1 PORTBbits.RB3#define R4 LATBbits.LATB4#define R3 LATBbits.LATB5#define R2 LATBbits.LATB8#define R1 LATBbits.LATB9int i = 0;int key = -1; //-1 means not pressint mode = 1; // mode 1: intial, mode 2 configuration, mode 3 Guess, mode 4 range, mode 5 result.int playernumber = 0;int GN = -1;int setnumber = 13;int S = -1;int RangeL = 0;int RangeH = 99;int counter = 0;int flash = 0b0;int time = 0;int flash_time = 300;int lowl;int lowr;int highl;int highr;int displayernumber;int B = 0;//	0-9 numbersunsigned char SSD_number[] = {    0b0111111, //0    0b0000110, //1    0b1011011, //2    0b1001111, //3    0b1100110, //4    0b1101101, //5    0b1111101, //6    0b0000111, //7    0b1111111, //8    0b1101111, //9    0b0000000, //clear 10    0b1111001, //E 11    0b0111000, //L 12    0b1110110, //H 13    0b0111001, //C 14};void displayDigit(unsigned char value, int a) {    SegA = value & 1;    SegB = (value >> 1) & 1;    SegC = (value >> 2) & 1;    SegD = (value >> 3) & 1;    SegE = (value >> 4) & 1;    SegF = (value >> 5) & 1;    SegG = (value >> 6) & 1;    DispSel = a;}void displayDigit1(unsigned char value, int a) {    SegA1 = value & 1;    SegB1 = (value >> 1) & 1;    SegC1 = (value >> 2) & 1;    SegD1 = (value >> 3) & 1;    SegE1 = (value >> 4) & 1;    SegF1 = (value >> 5) & 1;    SegG1 = (value >> 6) & 1;    DispSel1 = a;}void sets(int value) {    SLed1 = (value & 0b1000) >> 3;    SLed2 = (value & 0b0100) >> 2;    SLed3 = (value & 0b0010) >> 1;    SLed4 = (value & 0b0001);}void showNumber(int digit, int a) {    displayDigit(SSD_number[digit], a);}void showNumber1(int digit, int a) {    displayDigit1(SSD_number[digit], a);}void check() {    if (mode == 1) {//mode 1....................................................        if (key != -1) {            mode = 2;        }    } else if (mode == 2) {// mode 2 CO.........................................        if (key >= 1 && key <= 4) {            playernumber = key;        } else if (playernumber >= 1 && playernumber <= 4) {            if (key == 14) {//enter                mode = 3;                S = rand() % 100;                displayernumber = 1;            } else if (key == 15) {// F                mode = 3;                S = setnumber;                playernumber = 1;                displayernumber = 1;            } else if (key == 12 || key == 13) {                playernumber = 0;            }        }    } else if (mode == 3) {//mode 3 guess......................................        if (key >= 0 && key <= 9) {            if (GN == -1) {                GN = key;                lowl = 10;                lowr = GN;            } else if (GN >= 0 && GN <= 9) {                GN = GN * 10 + key;                lowl = GN / 10;                lowr = GN % 10;            }            //need to display some thing in somewhere        } else if (key == 12) { //clear            GN = -1;        } else if (key == 13) { //delete            GN = GN / 10;        } else if (key == 14) { //enter            if (GN <= RangeH && GN >= RangeL) {                mode = 5;            } else {                GN = -1;                mode = 3;            }        } else if (key == 15) { //display range F            mode = 4;        }    } else if (mode == 4) {//mode 4..........................................        if (key == 15) {            mode = 3;        }    } else if (mode == 5) {        if (GN < S) {            highl = highr = 12; //LL            if (key != -1) {                RangeL = GN + 1;                mode = 3;                GN = -1;                lowl = lowr = 10;                if (displayernumber >= (0b1 << (playernumber - 1))) {                    displayernumber = 1;                } else if (displayernumber < (0b1 << (playernumber - 1))) {                    displayernumber = displayernumber << 1;                }            }        } else if (GN > S) {            highl = highr = 13; //HH            if (key != -1) {                RangeH = GN - 1;                mode = 3;                GN = -1;                lowl = lowr = 10;                if (displayernumber >= (0b1 << (playernumber - 1))) {                    displayernumber = 1;                } else if (displayernumber < (0b1 << (playernumber - 1))) {                    displayernumber = displayernumber << 1;                }            }        } else if (GN == S) {            //displayernumber = 0b1111;            highl = highr = 11; //EE            lowl = S / 10;            lowr = S % 10;            if (key != -1) {                mode = 1;            }        }    }}// Handler of timer interrupt. It performs shift.void __ISR(_CHANGE_NOTICE_VECTOR, ipl4) ChangeNoticeHandler(void) {    //INTDisableInterrupts();    PORTB;    IEC1CLR = 0x1;    PORTB;    //showNumber(0b1);    for (i = 0; i < 10000; i++); //deboundce    R1 = R2 = R3 = R4 = 0;    if (C1 & C2 & C3 & C4) {        key = -1;        //return;    } else if (key == -1) {        R1 = 0;        R2 = 1;        R3 = 1;        R4 = 1;        if (C1 == 0) {            key = 1;        } else if (C2 == 0) {            key = 2;        } else if (C3 == 0) {            key = 3;        } else if (C4 == 0) {            key = 10;        } else {            R2 = 0;            R1 = 1;            R3 = 1;            R4 = 1;            if (C1 == 0) {                key = 4;            } else if (C2 == 0) {                key = 5;            } else if (C3 == 0) {                key = 6;            } else if (C4 == 0) {                key = 11;            } else {                R3 = 0;                R2 = 1;                R1 = 1;                R4 = 1;                if (C1 == 0) {                    key = 7;                } else if (C2 == 0) {                    key = 8;                } else if (C3 == 0) {                    key = 9;                } else if (C4 == 0) {                    key = 12;                } else {                    R4 = 0;                    R2 = 1;                    R3 = 1;                    R1 = 1;                    if (C1 == 0) {                        key = 0;                    } else if (C2 == 0) {                        key = 15;                    } else if (C3 == 0) {                        key = 14;                    } else if (C4 == 0) {                        key = 13;                    }                }            }        }        check();    }    //decode which key was pressed    PORTB;        R1 = R2 = R3 = R4 = 0;    PORTB;    IFS1CLR = 0x1;    //for (i = 0; i < 100000; i++); //deboundce    IEC1SET = 0x1;    //INTEnableInterrupts();}main() {    AD1PCFG = 0xFFFF;    //INTDisableInterrupts();    TRISB = 0xF;    TRISC = 0;    TRISD = 0;    TRISE = 0;    TRISF = 0;    TRISG = 0;    R1 = R2 = R3 = R4 = 0;    PORTC = 0x00;    PORTD = 0x00;    PORTE = 0x00;    PORTF = 0x00;    PORTG = 0x00;    CNCON = 0x8000;    CNEN = 0x3C; //use JJ    CNPUE = 0x3C;    PORTB;    IPC6SET = 0x100000;    IFS1CLR = 0x1;    IEC1SET = 0x1;    INTEnableSystemMultiVectoredInt();    //Configure ports C~G to be output ports    while (1) {        /* Current State Logic */        //showNumber(0b1);        if (mode == 1) {            RangeL = 0;            RangeH = 99;            GN = -1;            S = -1;            highl = highr = lowl = lowr = 10;            playernumber = 0;            sets(displayernumber = 0);        } else if (mode == 2) { //mode 2 configration...........................            highl = 14; //display CO            highr = 0;            lowr = playernumber;            lowl = 10;        } else if (mode == 3) {// guess mode3....................................            highl = highr = 10;            if (GN == -1) {                lowl =                        lowr = 10;            } else {                lowl = GN / 10;                lowr = GN % 10;            }            sets(displayernumber);        } else if (mode == 4) { //range mode4....................................            sets(displayernumber);            highl = RangeH / 10;            highr = RangeH % 10;            lowl = RangeL / 10;            lowr = RangeL % 10;        } else if (mode == 5) {// result mode5...................................            sets(displayernumber);            if (GN == S) {                B++;                if (B > 5000) {                    B = 0;                    for (i = 0; i < 8000; i++) {                        showNumber(10, 0);                        showNumber1(10, 0);                    }                }            }        }        ///////////////////////////////////////////////////////////////////////////////SSD display        time++;        if (time > flash_time) {            time = 0;            flash++;        }        flash = (flash & 1);        ;        if (flash == 1) {            showNumber(highl, flash);            showNumber1(lowl, flash);        } else {            showNumber(highr, flash);            showNumber1(lowr, flash);        }        //setPmodLed(0b11111111);    } // end of while loop}